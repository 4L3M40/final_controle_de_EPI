
{% extends "base.html" %}
{% block title %}Empréstimos{% endblock %}
{% block content %}
<h1>Empréstimos</h1>
<div class="row g-3 my-2 kpi-row">
<div class="col-sm-4"><div class="card p-3"><div class="small text-muted">Pendentes</div><div class="fs-4">{{ resumo.pendentes|default:0 }}</div></div></div>
  <div class="col-sm-4"><div class="card p-3"><div class="small text-muted">Atrasados</div><div class="fs-4">{{ resumo.atrasados|default:0 }}</div></div></div>
  <div class="col-sm-4"><div class="card p-3"><div class="small text-muted">Vencem em 48h</div><div class="fs-4">{{ resumo.vence_breve|default:0 }}</div></div></div>
</div>
<div class="actions">
  <form method="get" class="d-inline-flex align-items-center gap-2 ms-2">
    <input class="form-control" type="text" name="q" placeholder="Buscar por colaborador..." value="{{ q }}">
    <div class="form-check ms-2">
      <input class="form-check-input" type="checkbox" name="atrasados" value="1" id="chkAtrasados" {% if atrasados %}checked{% endif %}>
      <label class="form-check-label" for="chkAtrasados">Somente atrasados</label>
      </div>
      <div class="form-check ms-2">
        <input class="form-check-input" type="checkbox" name="vence_breve" value="1" id="chkVenceBreve" {% if request.GET.vence_breve %}checked{% endif %}>
        <label class="form-check-label" for="chkVenceBreve">Somente vencendo em 48h</label>
      </div>
      <div class="form-check ms-2">
        <input class="form-check-input" type="checkbox" name="pendentes" value="1" id="chkPendentes" {% if request.GET.pendentes %}checked{% endif %}>
        <label class="form-check-label" for="chkPendentes">Somente pendentes</label>
    </div>
    <button class="btn btn-outline-secondary ms-2" type="submit">Filtrar</button>
  </form>
  <a class="btn btn-primary" href="{% url 'epi:emprestimo_create' %}">+ Novo Empréstimo</a> <a class="btn btn-outline-secondary" href="{% url 'epi:emprestimos_csv' %}?q={{ q|urlencode }}&atrasados={{ request.GET.atrasados }}&vence_breve={{ request.GET.vence_breve }}&pendentes={{ request.GET.pendentes }}">Exportar CSV</a>
  </div>
<table class="table">
  <thead><tr><th>#</th><th>Colaborador</th><th>Prev. Devolução</th><th>Pendentes</th><th>Status</th><th>Ações</th></tr></thead>
  <tbody>
    {% for e in emprestimos %}
    <tr>
      <td>{{ e.id }}</td>
      <td>{{ e.colaborador.nome }}</td>
      <td>{{ e.previsao_devolucao|date:"d/m/Y H:i" }}</td>
      <td>{{ e.pendentes }}</td>
      <td>{{ e.status }}{% if e.atrasado %} <span class="badge text-bg-danger ms-2">Atrasado</span>{% elif e.vence_breve %} <span class="badge text-bg-warning ms-2">Vence em breve</span>{% endif %}</td>
      <td><a href="{% url 'epi:emprestimo_edit' e.pk %}">Editar / Devolução</a></td>
    </tr>
    {% empty %}
    <tr><td colspan="6">Nenhum empréstimo.</td></tr>
    {% endfor %}
  </tbody>
</table>
{% endblock %}

<nav aria-label="Paginação" class="mt-3">
  <ul class="pagination">
    {% if emprestimos.has_previous %}
      <li class="page-item"><a class="page-link" href="?page={{ emprestimos.previous_page_number }}&q={{ q|urlencode }}&atrasados={{ request.GET.atrasados }}&vence_breve={{ request.GET.vence_breve }}&pendentes={{ request.GET.pendentes }}">Anterior</a></li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">Anterior</span></li>
    {% endif %}
    <li class="page-item disabled"><span class="page-link">Página {{ emprestimos.number }} de {{ emprestimos.paginator.num_pages }}</span></li>
    {% if emprestimos.has_next %}
      <li class="page-item"><a class="page-link" href="?page={{ emprestimos.next_page_number }}&q={{ q|urlencode }}&atrasados={{ request.GET.atrasados }}&vence_breve={{ request.GET.vence_breve }}&pendentes={{ request.GET.pendentes }}">Próxima</a></li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">Próxima</span></li>
    {% endif %}
  </ul>
</nav>
