{% extends "base.html" %}
{% block title %}EPIs{% endblock %}

{% block content %}
{% if ca_vencidos and ca_vencidos > 0 %}
<div class="alert alert-warning" role="alert">
  {{ ca_vencidos }} EPIs com CA vencido.
</div>
{% endif %}

<h1 class="h4 my-3 mb-0">EPIs</h1>

<!-- 1) KPIs (mesmo padrão de Empréstimos) -->
<div class="row g-3 my-2 kpi-row">
  <div class="col-12 col-md-4">
    <div class="card h-100">
      <div class="card-body py-3">
        <div class="title fw-semibold mb-1">EPIs ativos</div>
        <div class="value mb-0">{{ resumo.ativos|default:0 }}</div>
      </div>
    </div>
  </div>
  <div class="col-12 col-md-4">
    <div class="card h-100">
      <div class="card-body py-3">
        <div class="title fw-semibold mb-1">CA vencidos</div>
        <div class="value mb-0">{{ resumo.ca_vencidos|default:0 }}</div>
      </div>
    </div>
  </div>
  <div class="col-12 col-md-4">
    <div class="card h-100">
      <div class="card-body py-3">
        <div class="title fw-semibold mb-1">Estoque zerado</div>
        <div class="value mb-0">{{ resumo.estoque_zerado|default:0 }}</div>
      </div>
    </div>
  </div>
</div>

<!-- 2) Barra de ações (igual Empréstimos): filtros à esquerda, botões à direita -->
<div class="row g-2 align-items-center mb-2">
  <div class="col-12 col-lg-6">
    <form method="get" class="d-flex flex-wrap align-items-center gap-2" role="search">
      <div class="form-check ms-1">
        <input class="form-check-input" type="checkbox" name="ca_vencido" value="1" id="chkCAVencido"
               {% if request.GET.ca_vencido %}checked{% endif %}>
        <label class="form-check-label" for="chkCAVencido">Somente CA vencidos</label>
      </div>
      <button class="btn btn-outline-secondary ms-1" type="submit">Filtrar</button>
    </form>
  </div>

  <div class="col-12 col-lg-6 d-flex justify-content-lg-end gap-2 mt-2 mt-lg-0">
    <a class="btn btn-primary" href="{% url 'epi:create' %}">+ Novo EPI</a>
    <a class="btn btn-outline-secondary"
       href="{% url 'epi:epis_csv' %}?q={{ q|urlencode }}&ca_vencido={{ request.GET.ca_vencido }}">
      Exportar CSV
    </a>
  </div>
</div>


<!-- Tabela -->
<div class="table-responsive mt-2">
  <table class="table table-striped table-hover align-middle">
    <thead class="table-light">
      <tr>
        <th>Código</th><th>Nome</th><th>Tamanho</th><th>Nº CA</th>
        <th>Validade CA</th><th>Alerta</th><th>Estoque</th><th style="width:160px">Ações</th>
      </tr>
    </thead>
    <tbody>
      {% for e in epis %}
      <tr>
        <td>{{ e.codigo }}</td>
        <td>{{ e.nome }}</td>
        <td>{{ e.tamanho|default:'-' }}</td>
        <td>{{ e.ca_numero|default:'-' }}</td>
        <td>{{ e.ca_validade|default:'-' }}</td>
        <td>{% if e.is_ca_vencido %}<span class="badge text-bg-danger">CA vencido</span>{% else %}-{% endif %}</td>
        <td>{{ e.estoque }}</td>
        <td class="text-nowrap">
          <a class="btn btn-sm btn-outline-primary" href="{% url 'epi:update' e.pk %}">Editar</a>
          <button type="button" class="btn btn-sm btn-outline-danger"
                  data-delete-url="{% url 'epi:delete' e.pk %}"
                  data-bs-toggle="modal" data-bs-target="#confirmDeleteModal">Excluir</button>
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="8" class="text-center text-muted">Nenhum EPI.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Paginação -->
<nav aria-label="Paginação" class="mt-3">
  <ul class="pagination">
    {% if epis.has_previous %}
      <li class="page-item"><a class="page-link" href="?page={{ epis.previous_page_number }}&q={{ q|urlencode }}&ca_vencido={{ request.GET.ca_vencido }}">Anterior</a></li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">Anterior</span></li>
    {% endif %}

    <li class="page-item disabled"><span class="page-link">Página {{ epis.number }} de {{ epis.paginator.num_pages }}</span></li>

    {% if epis.has_next %}
      <li class="page-item"><a class="page-link" href="?page={{ epis.next_page_number }}&q={{ q|urlencode }}&ca_vencido={{ request.GET.ca_vencido }}">Próxima</a></li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">Próxima</span></li>
    {% endif %}
  </ul>
</nav>

{% include "includes/confirm_delete_modal.html" %}
{% endblock %}
